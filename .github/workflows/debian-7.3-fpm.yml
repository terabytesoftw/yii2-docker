on:
  - pull_request
  - push

name: build

jobs:
  tests:
    name: debian-7.3-fpm

    runs-on: ubuntu-latest
    
    env:
      PHP_BASE_IMAGE_VERSION: 5.6-fpm
      DOCKERFILE_FLAVOUR: debian
      X_LEGACY_GD_LIB: 1
      key: cache-v1

    steps:
      - name: Before install
        run: |
          export TEST_YII_VERSION=a777c2e8f69dc753f8a945b1dd54bbaaa1e9e66c
          export DOCKER_COMPOSE_VERSION=1.25.4
          export PHP_IMAGE_NAME=yiisoftware/yii2-php      
          sudo apt-get update
          sudo apt-get install docker-ce
          sudo rm /usr/local/bin/docker-compose
          curl -L https://github.com/docker/compose/releases/download/${DOCKER_COMPOSE_VERSION}/docker-compose-`uname -s`-`uname -m` > docker-compose
          chmod +x docker-compose
          sudo mv docker-compose /usr/local/bin

      - name: Install
        run: |
          git clone https://github.com/yiisoft/yii2 _host-volumes/yii2
          pushd _host-volumes/yii2 && git checkout ${TEST_YII_VERSION} && popd
          cp .env-dist .env

      - name: Before script
        run: |
          pwd
          docker version
          docker info
          docker-compose version

      - name: Run script
        run: |
          docker-compose build --build-arg X_LEGACY_GD_LIB=$X_LEGACY_GD_LIB
          docker-compose run --rm php php -v
          docker-compose run --rm -e PHP_ENABLE_XDEBUG=1 php php -v
          docker-compose run --rm php php /tests/requirements.php
          docker-compose run --rm -w /yii2 php composer install --prefer-dist
          docker-compose run --rm -w /yii2 php php -d error_reporting="E_ALL ^ E_DEPRECATED" vendor/bin/phpunit tests/framework/ --exclude db          